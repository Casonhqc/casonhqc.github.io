<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>《Redis开发与运维》读书笔记 | 知行合一</title><meta name="keywords" content="Redis,读书笔记"><meta name="author" content="Cason"><meta name="copyright" content="Cason"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Redis 特性1.速度快 Redis 的数据都是放在内存中，相比于 Mysql 这类从磁盘加载数据的数据库要快上几个数量级  Redis 是用 C 语言实现的，一般来说 C 语言实现的程序更加底层，执行速度相对快  Redis 使用单线程架构，不需要考虑多线程产生的竞争问题 作为开源项目，作者自身的超高代码水平再结合世界各地的 Contributor 的贡献，造就了 Redis 的高性能。2.基">
<meta property="og:type" content="article">
<meta property="og:title" content="《Redis开发与运维》读书笔记">
<meta property="og:url" content="https://casonhqc.github.io/posts/b92a275f.html">
<meta property="og:site_name" content="知行合一">
<meta property="og:description" content="Redis 特性1.速度快 Redis 的数据都是放在内存中，相比于 Mysql 这类从磁盘加载数据的数据库要快上几个数量级  Redis 是用 C 语言实现的，一般来说 C 语言实现的程序更加底层，执行速度相对快  Redis 使用单线程架构，不需要考虑多线程产生的竞争问题 作为开源项目，作者自身的超高代码水平再结合世界各地的 Contributor 的贡献，造就了 Redis 的高性能。2.基">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://source.fomal.cc/img/default_cover_14.webp">
<meta property="article:published_time" content="2024-09-05T23:05:56.000Z">
<meta property="article:modified_time" content="2025-09-26T09:54:11.853Z">
<meta property="article:author" content="Cason">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="读书笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://source.fomal.cc/img/default_cover_14.webp"><link rel="shortcut icon" href="/assets/favicon.ico"><link rel="canonical" href="https://casonhqc.github.io/posts/b92a275f"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '《Redis开发与运维》读书笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-26 09:54:11'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="知行合一" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/IMG_6763.jpeg" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> 休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> 八音盒</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> 影院</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> 游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> 八宝箱</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> 画廊</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> 动画</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> 网址导航</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> 网站</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> 网站统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> 文章统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> 旧时光</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> 个人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> 唠叨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> 恋爱小屋</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">知行合一</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> 休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> 八音盒</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> 影院</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> 游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> 八宝箱</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> 画廊</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> 动画</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> 网址导航</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> 网站</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> 网站统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> 文章统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> 旧时光</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> 个人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> 唠叨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> 恋爱小屋</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> 关于</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="检索站内任何你想要的信息"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> 搜索</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="美化设置-自定义你的风格" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="浅色和深色模式转换" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">《Redis开发与运维》读书笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">发表于 </span><time class="post-meta-date-created" datetime="2024-09-05T23:05:56.000Z" title="发表于 2024-09-05 23:05:56">2024-09-05</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-26T09:54:11.853Z" title="更新于 2025-09-26 09:54:11">2025-09-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/%E4%B9%A6%E7%B1%8D%E7%AC%94%E8%AE%B0/">书籍笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">字数总计:</span><span class="word-count">1.4w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">阅读时长:</span><span>42分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="《Redis开发与运维》读书笔记"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Redis-特性"><a href="#Redis-特性" class="headerlink" title="Redis 特性"></a>Redis 特性</h1><h2 id="1-速度快"><a href="#1-速度快" class="headerlink" title="1.速度快"></a>1.速度快</h2><ul>
<li><p><strong>Redis</strong> <strong>的数据都是放在内存中</strong>，相比于 Mysql 这类从磁盘加载数据的数据库要快上几个数量级<br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250820113214.png" alt="image.png"></p>
</li>
<li><p><strong>Redis</strong> <strong>是用 C 语言实现的</strong>，一般来说 C 语言实现的程序更加底层，执行速度相对快</p>
</li>
<li><strong>Redis</strong> <strong>使用单线程架构</strong>，不需要考虑多线程产生的竞争问题</li>
<li>作为<strong>开源项目</strong>，作者自身的超高代码水平再结合世界各地的 Contributor 的贡献，造就了 Redis 的高性能。<h2 id="2-基于键值对的数据结构服务器"><a href="#2-基于键值对的数据结构服务器" class="headerlink" title="2.基于键值对的数据结构服务器"></a>2.基于键值对的数据结构服务器</h2>Redis 键值对中的值不仅可以是字符串，还可以是具体的数据结构。Redis 提供了五大数据结构：字符串、哈希、列表、集合、有序集合。还在字符串的基础上演变出了其他的数据结构<h2 id="3-丰富的功能"><a href="#3-丰富的功能" class="headerlink" title="3.丰富的功能"></a>3.丰富的功能</h2>Redis 在提供键值对数据存储功能之外，还提供了许多其他的功能：</li>
<li>提供<strong>键过期</strong></li>
<li>提供<strong>发布订阅功能</strong>，可以用来实现消息队列。</li>
<li>支持 lua 脚本功能，可以<strong>原子性地，组合式地执行</strong> <strong>Redis</strong> <strong>命令</strong></li>
<li>提供简单的事务功能，<strong>一定程度上保证事务特性</strong></li>
<li>提供 pipline 功能，客户端可以批量上传命令，减少网络开销<h2 id="4-简单稳定"><a href="#4-简单稳定" class="headerlink" title="4.简单稳定"></a>4.简单稳定</h2></li>
<li>Redis 的源码少，意味着容易吃透代码，更好地定位问题和优化。</li>
<li>Redis 使用单线程模型，开发时不需要考虑线程安全问题</li>
<li>Redis 内部使用了一个事件循环（event loop）来处理客户端请求、定时任务等事件。是 Redis 自己实现的，不需要外部类库的支持。<h1 id="API-的理解和使用"><a href="#API-的理解和使用" class="headerlink" title="API 的理解和使用"></a>API 的理解和使用</h1><h2 id="全局命令"><a href="#全局命令" class="headerlink" title="全局命令"></a>全局命令</h2></li>
<li><strong>查询所有键：</strong> keys *</li>
<li><strong>键总数</strong>： dbsize<blockquote>
<p><code>dbsize</code>是直接获取 Redis 内置的键总数，所以时间复杂度是 O（1），而<code>keys</code>命令需要遍历所有键，时间复杂度是 O（n）。当 Redis 保存了大量键时，线上环境禁止使用<code>keys</code>命令</p>
</blockquote>
</li>
<li>键是否存在：exists key</li>
<li>删除键： del key</li>
<li>键过期：expire key seconds</li>
<li>键对应值的数据类型： type key<h2 id="数据结构和内部编码"><a href="#数据结构和内部编码" class="headerlink" title="数据结构和内部编码"></a>数据结构和内部编码</h2>每种数据结构都有自己的底层内部编码实现，而且是多种实现，Redis 会在合适的场景选择合适的内部编码。<br>这样的设计有两个好处：</li>
<li>改进内部编码，对外的数据结构和命令没有影响。<strong>比如 list 早先只有 linkedlist 和 ziplist，而后设计除了结合二者优势的 quicklist，但是用户没有感知</strong>。</li>
<li>多种编码实现可以使用不同的场景。比如 ziplist 比较省空间，但是元素多的时候，性能下降，这时候就可以根据配置切换。<br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250820140131.png" alt="image.png"><h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><h3 id="重要命令"><a href="#重要命令" class="headerlink" title="重要命令"></a>重要命令</h3></li>
</ul>
<ol>
<li>Set key value 创建键值对，等于创建加更新。setnx 必须键不存在，才可以设置成功，代表只能添加。<strong>setxx 必须键存在才能执行成功，代表只能更新</strong>。</li>
<li>可以用<code>mget key1 key2 key3</code>来批量获取值，提高开发效率，也能够降低网络耗时。但是批量操作的数量不是无节制的，数量过多会导致 Redis 阻塞或者网络拥塞</li>
<li>incr 命令进行自增，<strong>因为</strong> <strong>Redis</strong> <strong>单线程的架构，不需要考虑加锁</strong><h3 id="内部编码"><a href="#内部编码" class="headerlink" title="内部编码"></a>内部编码</h3></li>
</ol>
<ul>
<li>int：8 个字节的长整型。</li>
<li>embstr：小于等于 39 个字节的字符串。直接存储在Redis的对象结构中</li>
<li>raw：大于 39 个字节的字符串。单独分配内存空间<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><h4 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h4>Redis 没有命令空间，设计合理的键名可以组织键冲突，提高项目的可维护性。推荐使用“业务名： 对象名： id ： [属性]” 。如果键名较长，可以在能够描述含义的情况下减上长度，比如<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user：&#123;uid&#125;：friends：messages：&#123;mid&#125;</span><br><span class="line">u：&#123;uid&#125;：fr：m：&#123;mid&#125;</span><br></pre></td></tr></table></figure>
<h4 id="计数"><a href="#计数" class="headerlink" title="计数"></a>计数</h4>可以实现快速计数、查询缓存的功能。<h4 id="共享-Session"><a href="#共享-Session" class="headerlink" title="共享 Session"></a>共享 Session</h4></li>
</ul>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250820140315.png" alt="image.png"></p>
<h4 id="限速"><a href="#限速" class="headerlink" title="限速"></a>限速</h4><p>利用 setnx 和递增 incr 来计数和频控。setnx + 过期时间避免一段时间内的反复请求，incr 保证计数的不会出错，限制总请求数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">key = <span class="string">&quot;shortMsg:limit:&quot;</span> + phoneNum;</span><br><span class="line"><span class="comment">// SET key value EX 60 NX</span></span><br><span class="line">isExists = redis.set(key,<span class="number">1</span>,<span class="number">60</span>,<span class="string">&quot;NX&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(isExists != <span class="literal">null</span> || redis.incr(key) &lt;=<span class="number">5</span>)&#123;</span><br><span class="line">    <span class="comment">// 通过</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">// 限速</span></span><br></pre></td></tr></table></figure></p>
<h2 id="哈希"><a href="#哈希" class="headerlink" title="哈希"></a>哈希</h2><p>Redis的Key对应的Value本身又是一个键值对。<br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250820142303.png" alt="image.png"></p>
<h3 id="重要命令-1"><a href="#重要命令-1" class="headerlink" title="重要命令"></a>重要命令</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">设置字段和值 </span><br><span class="line">HSET key field value</span><br><span class="line"></span><br><span class="line">获取指定字段的值 </span><br><span class="line">HGET key field</span><br><span class="line"></span><br><span class="line">获取所有字段和值 </span><br><span class="line">HGETALL key</span><br><span class="line"></span><br><span class="line">删除一个或多个字段 </span><br><span class="line">HDEL key field1 [field2 ...]</span><br><span class="line"></span><br><span class="line">同时设置多个字段和值 </span><br><span class="line">HMSET key field1 value1 field2 value2 ..</span><br></pre></td></tr></table></figure>
<p>可以使用hgetall key 获取所有的哈希元素，但是如果哈希元素个数较多，可能会阻塞。如果一定要获取全部，建议使用hscan命令。</p>
<h3 id="内部编码-1"><a href="#内部编码-1" class="headerlink" title="内部编码"></a>内部编码</h3><ul>
<li>ziplist：当哈希元素个数小于默认配置的512，且所有值都小于默认配置的64字节，使用ziplist更节省空间</li>
<li>hashtable：当不满足ziplist条件时，使用hashTable（哈希表）实现。因为ziplist在大数量2情况下，读写效率下降<h3 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h3><h5 id="缓存-1"><a href="#缓存-1" class="headerlink" title="缓存"></a>缓存</h5>相比于使用字符串缓存信息，比如用户信息，会更加直观，并且在更新操作上更加方便。使用字符串必须要进行序列化过程。字符串的优点是更节省空间<h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><h3 id="文章列表实现"><a href="#文章列表实现" class="headerlink" title="文章列表实现"></a>文章列表实现</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 用hash存储文章多个属性</span><br><span class="line">hmset article:1 title xx timestamp 1476536196 content xxx</span><br><span class="line"></span><br><span class="line">//将hash的key存到队列里</span><br><span class="line">lpush user:1:artcles article:1</span><br><span class="line"></span><br><span class="line">//分页取出第一个用户的0到9篇文章</span><br><span class="line">articles = lrange user:1:articles 0 9</span><br><span class="line">//遍历每个hash类型的文章，获取所有的属性（键值对）</span><br><span class="line">for article in &#123;articles&#125; </span><br><span class="line">    hgetall &#123;article&#125;</span><br></pre></td></tr></table></figure>
存在的问题：</li>
</ul>
<ol>
<li>如果分页出来的文章数量过多，需要循环执行多次hgeall<ol>
<li>考虑使用pipline</li>
<li>选择用字符串存文章数据，批量获取直接用mget</li>
</ol>
</li>
<li>如果列表较大，获取中间范围元素性能较低<ol>
<li>考虑使用quicklist的内部编码<h2 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h2>集合和列表最大的不同是，集合不允许有重复的元素且无序。Redis中的集合支持进行集合运算，比如交集，并集，差集<h3 id="重要命令-2"><a href="#重要命令-2" class="headerlink" title="重要命令"></a>重要命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">获取元素个数，O(1), Redis内部使用一个变量维护</span><br><span class="line">scard key</span><br><span class="line"></span><br><span class="line">随机选出一个元素并删除</span><br><span class="line">spop key</span><br><span class="line">随机选出一个元素不删除</span><br><span class="line">srandmemeber key</span><br><span class="line"></span><br><span class="line">交集    并集    差集</span><br><span class="line">sinter sunion sdiff</span><br></pre></td></tr></table></figure>
<h3 id="内部编码-2"><a href="#内部编码-2" class="headerlink" title="内部编码"></a>内部编码</h3>可以通过<code>object encoding key</code>查看内部编码</li>
</ol>
</li>
</ol>
<ul>
<li>intset: 当集合内的元素都是整数类型， 且小于默认配置的512个。</li>
<li>hashtable：只要不满足intset，直接使用hashtable。<h3 id="标签功能"><a href="#标签功能" class="headerlink" title="标签功能"></a>标签功能</h3></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 给用户加上tag</span><br><span class="line">sadd user:1:tag tage1 tag2 </span><br><span class="line"></span><br><span class="line">// 给tag加上用户</span><br><span class="line">sadd tag:1:users user:1 user2:2</span><br><span class="line"></span><br><span class="line">//计算用户的共同tag（兴趣）</span><br><span class="line">sinter user:1:tags user2:tags</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">计算用户的共同兴趣标签</span><br><span class="line">sinter user:1:tags user:2:tags</span><br><span class="line"></span><br><span class="line">计算一个兴趣下有多少用户</span><br><span class="line">SMEMBERS tag:tag1:users</span><br></pre></td></tr></table></figure>
<h2 id="有序集合（sorted-set）"><a href="#有序集合（sorted-set）" class="headerlink" title="有序集合（sorted set）"></a>有序集合（sorted set）</h2><p>既有集合不能重复元素的特性，又有列表的顺序特性。独特的特性是一个score，用来排序。</p>
<h3 id="重要命令-3"><a href="#重要命令-3" class="headerlink" title="重要命令"></a>重要命令</h3><p>有序集合也可以做集合运算<a href=""></a><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ZUNIONSTORE destination numkeys key [key ...] [WEIGHTS weight [weight ...]] [AGGREGATE SUM|MIN|MAX]</span><br><span class="line">ZINTERSTORE destination numkeys key [key ...] [WEIGHTS weight [weight ...]] [AGGREGATE SUM|MIN|MAX]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取第一个zset的成员</span></span><br><span class="line">ZRANGE zset1 0 -1 WITHSCORES</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从第二个zset中移除这些成员</span></span><br><span class="line">ZREM zset2 member1 member2 ...</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>destination</code>：将计算结果存到xxx键中。</li>
<li><code>numkeys</code>：需要做集合运算的key个数。</li>
<li><code>key</code>：要做集合运算的zset的键名。</li>
<li><code>WEIGHTS</code>：可选参数，指定每个zset的权重，默认为1。</li>
<li><code>AGGREGATE</code>：可选参数，指定如何聚合分数，可以是<code>SUM</code>（默认）、<code>MIN</code>或<code>MAX</code><h3 id="内部编码-3"><a href="#内部编码-3" class="headerlink" title="内部编码"></a>内部编码</h3></li>
<li>ziplist：当元素个数小于默认配置的128个，且元素的值大小小于默认配置的64字节。选择这种内部编码可以更节省空间</li>
<li>skiplist：当ziplist条件不满足，即使用skiplist。<h3 id="点赞功能"><a href="#点赞功能" class="headerlink" title="点赞功能"></a>点赞功能</h3></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">点赞</span><br><span class="line">zadd user:rank_likes:2024_08_05 mike 3</span><br><span class="line">zincrby user:rank_likes:20204_08_05 mike 1</span><br><span class="line"></span><br><span class="line">取消点赞</span><br><span class="line">zrem user:rank_likes:2024_08_05 mike</span><br><span class="line"></span><br><span class="line">展示点赞信息</span><br><span class="line">zrevrangebyrank，zscore， zrank</span><br></pre></td></tr></table></figure>
<h2 id="管理键（Key）"><a href="#管理键（Key）" class="headerlink" title="管理键（Key）"></a>管理键（Key）</h2><h3 id="单个键管理"><a href="#单个键管理" class="headerlink" title="单个键管理"></a>单个键管理</h3><h4 id="重命名Key"><a href="#重命名Key" class="headerlink" title="重命名Key"></a>重命名Key</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rename key newkey </span><br><span class="line"></span><br><span class="line">// 只有在原先的key不存在的情况下才会被覆盖</span><br><span class="line">renamenx key newkey</span><br></pre></td></tr></table></figure>
<blockquote>
<p>-重命名Key实际是先del删除旧的Key，所以如果原先的Key过大，会阻塞Redis</p>
<ul>
<li>如果key和newkey的值一样，在Redis3.2之前的版本会直接报错</li>
</ul>
</blockquote>
<h4 id="控制Key的过期时间"><a href="#控制Key的过期时间" class="headerlink" title="控制Key的过期时间"></a>控制Key的过期时间</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EXPIRE key seconds</span><br><span class="line"></span><br><span class="line">TTL key</span><br><span class="line"></span><br><span class="line">EXPIREAT key timestamp</span><br><span class="line"></span><br><span class="line">移除键的过期时间，使其永不过期。</span><br><span class="line">PERSIST key</span><br></pre></td></tr></table></figure>
<p><strong>字符串的set命令会去除Key原先设置的过期时间</strong></p>
<h4 id="迁移Key"><a href="#迁移Key" class="headerlink" title="迁移Key"></a>迁移Key</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">在Redis内部的多个数据库之间进行迁移</span><br><span class="line">move key db</span><br><span class="line"></span><br><span class="line">//在一台机子上执行，备份数据</span><br><span class="line">dump key</span><br><span class="line"></span><br><span class="line">另一台机子复原数据</span><br><span class="line">restore key ttl value</span><br><span class="line"></span><br><span class="line">这个过程是开启了两个客户端连接，将序列化数据经过客户端进行传输</span><br></pre></td></tr></table></figure>
<p><strong>migrate迁移</strong><br><code>MIGRATE target_host target_port key destination_db timeout [COPY] [REPLACE]</code></p>
<ul>
<li><code>target_host</code>：目标 Redis 实例的主机名或 IP 地址。</li>
<li><code>target_port</code>：目标 Redis 实例的端口号。</li>
<li><code>key</code>：要迁移的键名。</li>
<li><code>destination_db</code>：目标 Redis 实例的数据库编号。</li>
<li><code>timeout</code>：超时时间（以毫秒为单位），表示迁移操作的最大执行时间。</li>
<li><code>COPY</code>：可选参数，表示迁移后不删除源实例中的键。</li>
<li><code>REPLACE</code>：可选参数，表示如果目标实例中已存在同名键，则替换它。<br><strong>实际上是将dump，restore，del三个命令进行组合</strong>。首先这个过程是<strong>原子性</strong>的，不需要为每个Redis实例开启客户端，只需要在源Redis执行命令；其次这个备份的数据是直接在两个Redis之间进行转移的；最后目标Redis完成restore之后会发送Ok确认给源Redis，源Redis可以就此判断是否需要删除对应的键<h3 id="渐进式遍历Key"><a href="#渐进式遍历Key" class="headerlink" title="渐进式遍历Key"></a>渐进式遍历Key</h3>如果直接使用Keys命令，在Key的数量较大时，会引发阻塞。scan命令类似于游标分页，执行<code>scan cursor</code>后，得到的返回结果包含下一个游标以及若干个Keys。<strong>当遍历到最后一个元素时，返回的cursor就是0</strong><br>scan的这种思路也被用于解决其他阻塞问题。比如hgetall, smembers, zrange 等。在实际代码便携中，我们就可以使用scan配合while循环<h3 id="数据库管理"><a href="#数据库管理" class="headerlink" title="数据库管理"></a>数据库管理</h3>Redis用16个数字区分多个数据，连接数据库默认到0号数据库。但是Redis逐渐弱化这个设计。在搭建Redis Cluster时，只允许使用0号数据库。总结有三点原因：</li>
<li>Redis是单线程，使用多个数据库，<strong>使用的仍然是一个**</strong>CPU**。彼此之间还有有影响</li>
<li><strong>多数据库会让问题定位困难</strong>：比如一个数据库的慢查询，实际是会影响到其他的数据库的。从宏观返回状态下，你很难发现当前数据库的性能问题，是来自其他数据库的慢查询<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">数据库0：用于存储用户会话信息（例如，登录状态）。</span><br><span class="line">数据库1：用于存储实时统计数据（例如，页面访问量）</span><br><span class="line"></span><br><span class="line">数据库1中有一个复杂的查询，例如一个大的KEYS命令或一个长时间运行的Lua脚本</span><br><span class="line"></span><br><span class="line">由于Redis实例的资源是共享的，这个慢查询会导致整个实例的性能下降，包括数据库0。</span><br><span class="line">数据库0中的业务方（例如，用户会话管理服务）会突然发现响应时间变长，甚至出现超时。</span><br><span class="line">业务方可能会误以为问题出在自己的代码或配置上，而实际上是由于数据库1中的慢查询导致的</span><br></pre></td></tr></table></figure></li>
<li>部分Redis的客户端不支持切换数据库，即便支持，在开发的时候也容易弄混<h1 id="Redis的一些小工具"><a href="#Redis的一些小工具" class="headerlink" title="Redis的一些小工具"></a>Redis的一些小工具</h1></li>
</ul>
<h2 id="慢查询分析"><a href="#慢查询分析" class="headerlink" title="慢查询分析"></a>慢查询分析</h2><p>Redis客户端到服务器执行一条命令分为<strong>：发送命令，命令排队，命令执行，返回结果</strong>。其中慢查询着重关注命令执行这个环节的时间。</p>
<h3 id="两个配置参数"><a href="#两个配置参数" class="headerlink" title="两个配置参数"></a>两个配置参数</h3><p><strong>slowlog-log-slower-than：</strong> 如果执行命令时间超过了这个值，就会被记录在慢查询日志中。如果这个值设置小于0，那么不会记录任何命令；设置为0，则记录所有命令<br><strong>slowlog-max-len：</strong>Redis使用内存中的一个列表来记录慢查询日志，所以如果新插入的命令，导致列表长度将突破这个值时，会将队头的数据移除后，再插入当前命令。</p>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><p>获取慢查询日志<br><code>Slowlog get [n]</code><br>每个慢查询日志结果由四部分组成：标识id，发生的时间戳，命令耗时，执行命令和对应的参数<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    slowlog get</span><br><span class="line"> 1) 1) (integer) 666</span><br><span class="line">    2) (integer) 1456786500</span><br><span class="line">    3) (integer) 11615</span><br><span class="line">    4) 1) &quot;BGREWRITEAOF&quot;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"> 2) 1) (integer) 665</span><br><span class="line">    2) (integer) 1456718400</span><br><span class="line">    3) (integer) 12006</span><br><span class="line">    4) 1) &quot;SETEX&quot;</span><br><span class="line">       5) &quot;video_info_200&quot;</span><br><span class="line">       6) &quot;300&quot;</span><br><span class="line">       7) &quot;2&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><br>要点注意：</p>
<ul>
<li><strong>slowlog-max-len配置建议：线上建议调大慢查询列表，记录慢查询时Redis会对长命令做截断操作，并不会占用大量内存。增大慢查询列表可以减缓慢查询被剔除的可能</strong>，例如线上可设置为1000以上。</li>
<li><strong>slowlog-log-slower-than配置建议：默认值超过10毫秒判定为慢查询，需要根据Redis并发量调整该值。由于Redis采用单线程响应命令，对于高流量的场景，如果命令执行时间在1毫秒以上，那么Redis最多可支撑OPS不到1000</strong>。因此对于高OPS场景的Redis建议设置为1毫秒。</li>
<li>慢查询只记录命令执行时间，并不包括命令排队和网络传输时间。因此<strong>客户端执行命令的时间会大于命令实际执行时间</strong>。因为命令执行排队机制，<strong>慢查询会导致其他命令接连阻塞</strong>，因此当客户端出现请求超时，需要检查该时间点是否有对应的慢查询，从而分析出是否为慢查询导致的命令级联阻塞。</li>
<li>由于慢查询日志是一个先进先出的队列，也就是说如果慢查询比较多的情况下，可能会丢失部分慢查询命令，为了防止这种情况发生，可以<strong>定期执行slow get命令将慢查询日志持久化到其他存储中</strong>（例如MySQL），然后可以制作可视化界面进行查询<h2 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h2>Redis的瓶颈主要是网络的延迟和吞吐，所以要<strong>尽可能的减少网络的**</strong>IO<strong>**次数</strong>，也就是使用批处理命令。Redis大多数的命令本身不是批量的，比如hgetall，获取一个hash的所有键值对，但是就没有mhgetall，需要执行n词。</li>
</ul>
<p>pipeline的作用就是将一组Redis命令组装，然后通过一次命令的传输和执行完成，减少了网络往返的次数。目前很多编程语言客户端都支持pipeline，比如jedis</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// 创建 Jedis 实例</span><br><span class="line">Jedis jedis = new Jedis(&quot;localhost&quot;, 6379);</span><br><span class="line"></span><br><span class="line">try &#123;</span><br><span class="line">    // 创建 Pipeline 实例</span><br><span class="line">    Pipeline pipeline = jedis.pipelined();</span><br><span class="line"></span><br><span class="line">    // 添加命令到 Pipeline</span><br><span class="line">    pipeline.set(&quot;key1&quot;, &quot;value1&quot;);</span><br><span class="line">    pipeline.set(&quot;key2&quot;, &quot;value2&quot;);</span><br><span class="line">    pipeline.get(&quot;key1&quot;);</span><br><span class="line">    pipeline.get(&quot;key2&quot;);</span><br><span class="line"></span><br><span class="line">    // 执行 Pipeline</span><br><span class="line">    List&lt;Object&gt; responses = pipeline.syncAndReturnAll();</span><br><span class="line"></span><br><span class="line">    // 处理响应</span><br><span class="line">    for (Object response : responses) &#123;</span><br><span class="line">        System.out.println(&quot;Response: &quot; + response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; finally &#123;</span><br><span class="line">    // 关闭 Jedis 连接</span><br><span class="line">    jedis.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过下面这张表格的时间对比，得出</p>
<ul>
<li>本机网络环境，性能提升约4.28倍</li>
<li>内网环境下，提升约6.71倍</li>
<li>在异地机房环境下，提升超过70倍<br>延迟时间越长，使用Pipeline的优势越明显</li>
</ul>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822113422.png" alt="image.png"></p>
<blockquote>
<p>Pipeline组装的命令个数不能没有节制，否则会增加客户端的等待时间，同时可能造成网络阻塞</p>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>Redis提供简单的事务功能，用multi代表事务开始，用exec代表事务的结束。在事务中出现不同类型的错误，回滚机制不同</p>
<h3 id="命令错误"><a href="#命令错误" class="headerlink" title="命令错误"></a>命令错误</h3></blockquote>
<p>也就是语法错误，比如把set写成了sett，不论执行的顺序，因为<strong>事务开启后，都会进入Queued状态，这个错误会让整个事务无法执行。</strong></p>
<h3 id="运行时错误"><a href="#运行时错误" class="headerlink" title="运行时错误"></a>运行时错误</h3><p>比如我用一个zadd命令去操作一个普通集合，会出现<code>WRONGTYPE Operation against a key holding the wrong kind of value</code>，但是这个错是在执行了命令之后抛出来的，所以zadd命令会失败，但是事务中的其他命令执行成功，无法回滚。</p>
<h3 id="Watch乐观锁"><a href="#Watch乐观锁" class="headerlink" title="Watch乐观锁"></a>Watch乐观锁</h3><p>Redis是单线程执行命令，但是存在多个客户端，一个客户端事务内的多条命令不能保证原子性执行。为了确保事务中的key没有被其他的客户端修改，在事务开启前，添加一个watch命令，事务执行时，会做一个compare and set的乐观锁判断。</p>
<h2 id="lua脚本"><a href="#lua脚本" class="headerlink" title="lua脚本"></a>lua脚本</h2><p>一个lua脚本内的执行逻辑，redis命令，会被看作是一条命令来执行。<br>常用的lua脚本使用过程是：客户端调用script load 命令把脚本内容加载到Redis的内存中，然后得到一个SHA1的校验和。想要执行这个lua脚本，就通过下面的命令<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evalsha 脚本SHA1值 key个数 key列表参数列表</span><br></pre></td></tr></table></figure></p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822113617.png" alt="image.png"></p>
<p>lua脚本会一直常驻在服务端，避免了发送Lua脚本的开销。脚本功能得到了复用。</p>
<p>lua脚本有三大好处：</p>
<ul>
<li>首先就是前面说的<strong>ua脚本是当作一条命令，原子执行的</strong></li>
<li>开发者可以利用lua脚本<strong>个性化定制Redis命令，脚本常驻Redis内存</strong></li>
<li>lua脚本可以将多条命令打包，<strong>和pipeline一样会减少网络开销</strong><br>lua脚本执行的注意事项：</li>
<li>lua脚本如果执行比较耗时，那么Redis会被阻塞，其他客户端的请求需要等到脚本执行结束或者进行外部干预</li>
<li>如果想终止lua脚本的执行，可以使用script kill。但是这个命令不能终止正在进行写操作的脚本<h2 id="发布订阅"><a href="#发布订阅" class="headerlink" title="发布订阅"></a>发布订阅</h2><strong>发布者</strong>（Publisher）发布消息到一个或多个频道（Channel），这个过程是非阻塞的。发布者无需等待订阅者（Subscriber）接收到消息后再继续执行其他操作。<br><code>PUBLISH channel:sports &quot;James lost the championship&quot;</code><br><strong>订阅者</strong>（Subscriber）订阅一个或多个频道，订阅者会接收到发布者发布的消息。这些消息会通过 Redis 的事件循环机制异步推送给订阅者。<br><code>SUBSCRIBE channel:sports</code><br>注意：订阅者客户端在调用 <code>SUBSCRIBE</code> 命令后，会进入一个阻塞循环，持续等待来自服务器的消息。<h1 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h1><h2 id="JAVA客户端大对比"><a href="#JAVA客户端大对比" class="headerlink" title="JAVA客户端大对比"></a>JAVA客户端大对比</h2><strong>Jedis</strong>:</li>
<li><strong>同步支持</strong>: Jedis 是一个同步的 Redis 客户端，所有命令都是阻塞的。</li>
<li><strong>线程安全性</strong>: Jedis 本身不是线程安全的，需要使用连接池（如 JedisPool）来管理多个线程的连接。<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1678172">jedis线程安全分析</a></li>
<li><strong>API</strong> <strong>风格</strong>: API 设计接近原生 Redis 命令，简单易用。</li>
<li><strong>适用场景</strong>: 适合简单应用和小型项目，不需要复杂的异步处理和高级分布式功能。<br><strong>Lettuce</strong>:</li>
<li><strong>同步和异步支持</strong>: 支持同步和异步操作，并且支持反应式编程（Reactive Programming）。</li>
<li><strong>线程安全性</strong>: 线程安全的多线程设计，适合高并发环境。</li>
<li><strong>API</strong> <strong>风格</strong>: 提供函数式编程风格的 API，支持复杂的异步和反应式操作。</li>
<li><strong>适用场景</strong>: 适合需要高并发处理、异步操作和反应式编程的应用。<br><strong>Redisson</strong>:</li>
<li><strong>同步和异步支持</strong>: 支持同步和异步操作。</li>
<li><strong>线程安全性</strong>: 线程安全，自动管理连接池。</li>
<li><strong>API</strong> <strong>风格</strong>: 提供高级的面向对象 API，支持广泛的分布式对象和结构。</li>
<li><strong>高级特性</strong>: 提供分布式锁、分布式集合、分布式列表等高级分布式功能。</li>
<li><strong>适用场景</strong>: 适合复杂的分布式系统，需要高级分布式功能和对象支持的场景。<h2 id="客户端管理命令"><a href="#客户端管理命令" class="headerlink" title="客户端管理命令"></a>客户端管理命令</h2>使用client list 可以列出所有客户端连接信息，包含以下信息<h3 id="客户端标识"><a href="#客户端标识" class="headerlink" title="客户端标识"></a>客户端标识</h3>比如，自增的Id，addr包含客户端ip和端口，名字，socket文件描述符<h3 id="输入缓冲区"><a href="#输入缓冲区" class="headerlink" title="输入缓冲区"></a>输入缓冲区</h3>Redis给每个客户端都会分配一块内存空间，<strong>临时保存客户端的命令</strong>，每次执行的命令都是从输入缓冲区拉取的。qbuf和qbuf-free就代表缓冲区的总容量和剩余容量。Redis要求客户端的缓冲区大小不能超过1G，否则客户端会被关闭<h2 id="客户端常见异常"><a href="#客户端常见异常" class="headerlink" title="客户端常见异常"></a>客户端常见异常</h2></li>
</ul>
<h3 id="无法从连接池获取到连接"><a href="#无法从连接池获取到连接" class="headerlink" title="无法从连接池获取到连接"></a>无法从连接池获取到连接</h3><p>客户端角度分析，JedisPool的jedis对象默认个数是8个，获取不到连接那说明此时连接池中没有多余的Jedis对象了。有可能是高并发下，<strong>资源都被抢走了</strong>；也有可能是其他的调用者占用资源迟迟未归还，<strong>这种未归还可能是存在慢查询，或者就是代码忘了写归还操作</strong>。<br>从服务端角度分析，服务端可能是出于某些原因发生了阻塞，导致客户端迟迟无法归还连接。</p>
<h3 id="客户端缓冲区异常"><a href="#客户端缓冲区异常" class="headerlink" title="客户端缓冲区异常"></a>客户端缓冲区异常</h3><p>客户端输出缓冲区是用来<strong>存放服务端执行命令后的结果的</strong>，所以如果客户端请求的是一个大key，那么可能把输出缓冲区冲满。<br>还有一种可能性就是<strong>Jedis对象在并发情况下操作</strong>，可以回到上面的jedis并发问题分析。</p>
<h3 id="客户端案例分析"><a href="#客户端案例分析" class="headerlink" title="客户端案例分析"></a>客户端案例分析</h3><h4 id="Redis内存陡增"><a href="#Redis内存陡增" class="headerlink" title="Redis内存陡增"></a>Redis内存陡增</h4><p>现象是服务端的主节点内存陡增，逼近maxmemory，而从节点没有变化。客户端抛出OOM异常，无法写入新的数据了</p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822161845.png" alt="image.png"></p>
<p>分析思路是：</p>
<ul>
<li>主节点内存陡增，首先猜测有大量的写入。但是为什么从节点没有同步更新呢？最先想到的就是<strong>同步出现异常</strong>，通过dbsize查询两个节点的Key数量，发现一致。这个原因pass</li>
<li>还有其他的原因会导致主节点内存陡增吗？节点的内存除了存主要数据，<strong>还有一部分是分出来作为输入和输出的缓冲区的</strong>。通过info clients查询客户端的信息<br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822161913.png" alt="image.png"></li>
</ul>
<p>发现这里输出缓冲区明显异常（最大的客户端输出缓冲区有20w+对象），一定有客户端的omem不是0（因为正常情况下，处理速度足够快，omem为0）。 用grep命令来定位，找到异常客户端的命令记录。发现是执行了monitor命令。<br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822162117.png" alt="image.png"></p>
<h4 id="客户端周期性超时"><a href="#客户端周期性超时" class="headerlink" title="客户端周期性超时"></a>客户端周期性超时</h4><p>客户端发现出现大量超时且周期性出现，而服务端没有明显的异常，有一些慢查询操作。<br>分析思路：</p>
<ul>
<li>首先查看网络状况，观察网络是否有波动</li>
<li>观察Redis的日志，判断Redis本身是否出现异常</li>
<li>对比慢查询日志和客户端耗时监控，发现<strong>周期相似</strong>，定位到是慢查询操作导致的。</li>
</ul>
<blockquote>
<p>这个案例凸显出来了客户端监控的重要性。</p>
<h1 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h1></blockquote>
<p>Redis对数据的操作都是在内存完成的，我们需要持久化技术，保证在Redis进程退出，重启，宕机情况下，能够再次恢复到之前的状态。</p>
<h2 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h2><p>将某一个时刻下，数据库的所有数据保存为一个二进制文件。</p>
<h3 id="触发机制"><a href="#触发机制" class="headerlink" title="触发机制"></a>触发机制</h3><p>手动执行命令save或者bgsave会开始创建RDB快照文件，前者是同步阻塞，后者是通过fork异步完成的。<br>还有一些情况下是自动触发RDB持久化</p>
<ol>
<li>配置文件配置“save m n” 表示<strong>m秒内如果数据集存在n次修改</strong>，会自动触发bgsave</li>
<li>主从架构下，从节点进行全量复制，<strong>主节点会自动执行bgsave</strong>生成RDB文件给从节点</li>
<li>执行debug reload，重新加载Redis，也会触发</li>
<li>在执行shutdown之后，也会自动触发<h3 id="流程说明"><a href="#流程说明" class="headerlink" title="流程说明"></a>流程说明</h3></li>
<li>执行bgsave，先判断是否有<strong>正在执行的RDB或AOF的子进程</strong>，如果有直接返回</li>
<li>父进程执行<strong>fork操作</strong>创建子进程，fork过程父进程处于阻塞状态。</li>
<li>fork完成后，bgsave返回结果，父进程继续响应其他命令</li>
<li>子进程和父进程<strong>共享同一块内存</strong>，根据内存里的数据，生成临时快照文件，完成后覆盖原有的文件。<br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822162255.png" alt="image.png"></li>
</ol>
<p>这里的RDB文件存放到dir配置的指定目录下。还可以执行<code>config set dir&#123;newDir&#125;</code>来更改存放目录。</p>
<h3 id="优缺点分析"><a href="#优缺点分析" class="headerlink" title="优缺点分析"></a>优缺点分析</h3><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li>RDB是代表Redis在某一个时刻下的数据快照，即全部的数据，适用于备份，全量复制。</li>
<li>RDB是二进制文件，恢复数据更快<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4></li>
<li>RDB只能记录某一个时刻的数据，<strong>时效性较低</strong></li>
<li>RDB的二进制格式是特定的，存在一个版本的兼容性问题</li>
<li>因为bgsave会fork创建子进程，如果频繁执行，<strong>成本太高</strong>。<blockquote>
<ul>
<li>内存复制和CPU开销</li>
<li>磁盘I/O负载和空间占用 </li>
<li>内核态和用户态的切换<h2 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h2>Append Only File, 只追加文件。做增量数据的备份。保存的是Redis执行过的写命令<h3 id="流程说明-1"><a href="#流程说明-1" class="headerlink" title="流程说明"></a>流程说明</h3></li>
</ul>
</blockquote>
</li>
<li>对于写入的命令，追加到AOF缓冲区中</li>
<li>AOF缓冲区根据同步策略，选择时机执行sync命令，将数据同步到硬盘</li>
<li>当AOF文件过大时，会执行重写操作</li>
<li>当Redis重启，会加载AOF文件进行数据恢复<blockquote>
<p>这里使用aof缓冲区是因为，Redis单线程响应命令，<strong>如果每次写命令都直接写到硬盘，那么根据短板效应，性能就取决于磁盘负载了</strong>。</p>
</blockquote>
</li>
</ul>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822163839.png" alt="image.png"></p>
<h4 id="同步策略"><a href="#同步策略" class="headerlink" title="同步策略"></a>同步策略</h4><ul>
<li>always：每次写入AOF缓冲区都要同步到AOF文件。</li>
<li>no：将同步的时机交给操作系统</li>
<li><p>everysec：每秒进行一次同步，最多会有一秒的数据丢失</p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822163856.png" alt="image.png"></p>
</li>
</ul>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822163905.png" alt="image.png"></p>
<h3 id="重写机制"><a href="#重写机制" class="headerlink" title="重写机制"></a>重写机制</h3><p>AOF是追加操作，文件的大小会一直增大，当超过一定大小，我们应该考虑缩减大小。<br><strong>重写是如何实现文件的缩小的？</strong></p>
<ul>
<li>对已经过期的数据不再写入</li>
<li>对无效的命令，比如del，连续set等，都<strong>只保留最终数据对应的写命令</strong></li>
<li>将多条写命令合成一个，比如<strong>一次性将多个元素lpush到list中</strong><h4 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h4></li>
<li>首先会判断是否有bgsave在执行，因为<strong>重写的参考数据来自于RDB文件</strong>，所以如果有bgsave，会等到bgsave结束后在执行。</li>
<li>父进程进行fork操作，阻塞直到fork完成，然后继续响应其他命令。期间的执行的写命令都会放到AOF重写缓冲区中。</li>
<li>子进程<strong>根据RDB文件开始写入写命令</strong>到新的AOF文件</li>
<li>新AOF文件写完成后，子进程发送信号给父进程，父进程将<strong>AOF重写缓冲区的补充写入</strong>到AOF文件中</li>
<li>用新的AOF文件替换老文件</li>
</ul>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822163953.png" alt="image.png"></p>
<h2 id="问题定位和优化"><a href="#问题定位和优化" class="headerlink" title="问题定位和优化"></a>问题定位和优化</h2><h3 id="fork操作"><a href="#fork操作" class="headerlink" title="fork操作"></a>fork操作</h3><h4 id="fork操作潜在的问题是什么？"><a href="#fork操作潜在的问题是什么？" class="headerlink" title="fork操作潜在的问题是什么？"></a>fork操作潜在的问题是什么？</h4><p>在进行RDB或者AOF重写时，都会执行fork操作。但是fork操作<strong>相对耗时</strong>，因为需要复制父进程的信息，其中虽然不需要直接拷贝父进程的内存空间，但是需要<strong>复制内存页表</strong>，在总内存较大时，也非常耗时间。其次还需要考虑到fork期间，<strong>父进程一旦执行写操作，那么必然需要进行内存空间的复制</strong>。</p>
<h4 id="如何优化"><a href="#如何优化" class="headerlink" title="如何优化"></a>如何优化</h4><ul>
<li>优先使用物理机，或者支持高效执行fork的虚拟化技术</li>
<li>合理控制每个Redis实例的内存</li>
<li><strong>降低fork操作的频率</strong>，对应就是尽量避免AOF的重写，RDB的频繁自动触发等。<h3 id="子进程开销监控和优化"><a href="#子进程开销监控和优化" class="headerlink" title="子进程开销监控和优化"></a>子进程开销监控和优化</h3></li>
</ul>
<h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><p>子进程的工作是把父进程的数据批量写入文件，这是一个CPU密集操作。所以应该避免出现CPU的过度竞争</p>
<ul>
<li>比如不要把Redis绑定到单核CPU上，子进程会和父进程抢夺一个CPU</li>
<li>不要把Redis和其他的CPU密集型任务部署到一起。<h4 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h4>子进程需要复制父进程的页表，如果父进程需要执行写入操作，那么还需要创建新的内存页。<br>所以需要<strong>避免在大量写入时，做子进程重写操作</strong>。<br>Linux后续更新了一个Transparent Huge Pages功能，这会导致fork的时候，每次复制的数据页单位从4KB变为2MB，大幅增加重写的内存消耗。<h4 id="硬盘"><a href="#硬盘" class="headerlink" title="硬盘"></a>硬盘</h4>持久化的文件最后都是要写入磁盘的。磁盘写入也是有负载压力，所以优化的思路也是</li>
<li>不要和其他高硬盘负载服务部署在一台机子上，比如消息队列</li>
<li>普通机械硬盘的吞吐量一般在100MB/s，所以如果是高流量下的AOF，那么性能瓶颈就会出现在AOF同步磁盘<h3 id="AOF追加阻塞"><a href="#AOF追加阻塞" class="headerlink" title="AOF追加阻塞"></a>AOF追加阻塞</h3>AOF持久化，数据同步到磁盘的过程是由一个子线程执行fsync完成的。这个线程会在everysec配置下，每秒执行一次fsync，并且记录同步开始的时间。</li>
</ul>
<p>主线程在执行下一次写命令，写入AOF缓冲区，就会去对比一下，现在和上次同步时间间隔多久：</p>
<ul>
<li>如果在两秒内，那可以直接返回，放心让子线程完成最后同步。</li>
<li>如果大于两秒，那么会直接阻塞，直到同步操作完成。</li>
</ul>
<p>这里选择阻塞，意味着这段时间内的请求都不能处理。也就不会有新的数据进入</p>
<h1 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h1><p>在分布式系统中，通常数据会有多份副本，部署在不同的机器上，满足故障恢复和负载均衡等需求。复制就是Redis高可用的基础，</p>
<h2 id="拓扑图"><a href="#拓扑图" class="headerlink" title="拓扑图"></a>拓扑图</h2><h3 id="一主一从"><a href="#一主一从" class="headerlink" title="一主一从"></a>一主一从</h3><p>实现最基本的读写分离。</p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822165301.png" alt="image.png"></p>
<h3 id="一主多从"><a href="#一主多从" class="headerlink" title="一主多从"></a>一主多从</h3><p>从节点负责处理读命令，可以有效的降低慢查询对主节点的阻塞。但是多个从节点意味着，主节点需要多<strong>次发送写命令给从节点来</strong>保持数据的同步</p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822165313.png" alt="image.png"></p>
<h3 id="树状主从"><a href="#树状主从" class="headerlink" title="树状主从"></a>树状主从</h3><p>部分从节点不仅复制主节点的数据，同时也可以作为其他从节点的主节点，将复制的数据向下继续传递。相当于将<strong>主节点的负载和传输压力降低</strong>，让二级主节点进一步承担。</p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822165321.png" alt="image.png"></p>
<h2 id="流程分析-1"><a href="#流程分析-1" class="headerlink" title="流程分析"></a>流程分析</h2><p>从节点执行slaveof命令后，经过六步完成复制。</p>
<h3 id="1-保存主节点的信息"><a href="#1-保存主节点的信息" class="headerlink" title="1.保存主节点的信息"></a>1.保存主节点的信息</h3><p>通过执行 info replication，就能够看到主节点的相关信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:down</span><br></pre></td></tr></table></figure>
<h3 id="2-与主节点建立socket命令"><a href="#2-与主节点建立socket命令" class="headerlink" title="2.与主节点建立socket命令"></a>2.与主节点建立socket命令</h3><p>从节点要开启一个端口，建立socket来同步数据。这里是通过一个<strong>定时任务</strong>，每次任务执行，就是去查看是否发现新的主节点，然后尝试建立连接。这同时也说明，如果尝试一直失败，那么会一直重试</p>
<h3 id="3-发送ping命令"><a href="#3-发送ping命令" class="headerlink" title="3.发送ping命令"></a>3.发送ping命令</h3><p><strong>建立了连接之后，会发送ping</strong>，看主从之间的socket是否可用，并且主节点当前是否能够接受且处理命令。如果收不到pong或者超时，就会<strong>主动断开连接，等下次定时任务发起重连</strong></p>
<h3 id="4-权限验证"><a href="#4-权限验证" class="headerlink" title="4.权限验证"></a>4.权限验证</h3><p>考虑到有些主节点设置了密码验证，那么从节点需要提供相同的密码通过验证</p>
<h3 id="5-同步数据"><a href="#5-同步数据" class="headerlink" title="5.同步数据"></a>5.同步数据</h3><p>从节点通过发送<strong>psync命令</strong>给主节点，进行全量或者部分复制。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">命令格式：psync&#123;runId&#125;&#123;offset&#125;，</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><p>这里的runId是Redis每次运行时产生的唯一ID</p>
</li>
<li><p>offset代表从节点的复制进度（偏移量）</p>
</li>
</ul>
</blockquote>
<p>在命令传播过程中，主从节点维护更新偏移量，这是二者数据一致性的体现。</p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822165411.png" alt="image.png"></p>
<h4 id="全量复制"><a href="#全量复制" class="headerlink" title="全量复制"></a>全量复制</h4><p>当从节点和主节点第一次建立连接时，发起全量复制。这时候，从节点对主节点是很陌生的，所以psync命令的主<strong>节点运行Id和复制偏移量都是-1.</strong></p>
<p>主节点收到这样的psync命令，明白这个从节点是第一次连接，所以会响应FULLRESYNC, 并且返回自己的运行ID和offset。</p>
<p>主节点还需要给从节点提供自己的数据集，所以要执行bgsave<strong>，生成一份RDB文件</strong>保存在本地，然后发送给从节点。</p>
<blockquote>
<p>这里其实可以通过repl-diskless-sync参数，不落盘，直接通过网络传输过去。</p>
</blockquote>
<p>从节点收到RDB文件后，也是保存到本地。</p>
<blockquote>
<p>这里会有一种失败的情况。因为有一个配置叫repl-timeout，这是RDB文件传输耗时的阈值，如果文件过大，超过这个阈值，从节点会放弃复制的数据。</p>
</blockquote>
<p>在从节点加载数据的时候，主节点也没有闲着，还是会处理写命令。为了同步这部分增量数据，主节点会将这些写命令保存在“复制客户端缓冲区”，在从节点完成RDB的加载后，将增量数据发送出去。<br>从节点加载RDB数据的过程，是首先要<strong>把老数据给删除</strong>了，然后再读取RDB文件。<strong>如果这个时候有读命令，还是会响应。</strong><br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822165527.png" alt="image.png"></p>
<h4 id="部分复制"><a href="#部分复制" class="headerlink" title="部分复制"></a>部分复制</h4><p>就像全量复制，从节点由于在接受和加载RDB文件时，主节点还在正常响应命令，会存在数据不一致。那么后续也有可能因为网络，从节点的稳定性导致数据再次出现不一致。<br>所以主节点，还有一个“复制积压缓冲区”，大小默认1MB，可以<strong>保存最近一段时间的写命令。</strong><br>如果主从的连接因为某些原因中断，那么当恢复之后，从节点中再次发起psync，而这时候，就会带上已知的参数“运行ID和offset”。<br>主节点验证运行ID和自己一致后，再检查offset是否还在缓冲区，如果在就会将offset后的数据返回。</p>
<h3 id="6-保持连接持续复制数据"><a href="#6-保持连接持续复制数据" class="headerlink" title="6.保持连接持续复制数据"></a>6.保持连接持续复制数据</h3><p>主从连接后，双方维持一个长链接，彼此发送心跳命令。<br><strong>主节点：</strong><br>每十秒发送ping，判断从节点的状态<br><strong>从节点：</strong><br>每秒发送replconf ack{offset} ，上报自己的offset，既可以监控和主节点的连接，又可以让主节点检查自己的数据是否一直，没有丢失。</p>
<p>在主从保持正常连接时，主节点会异步地将自己处理的新写命令同步给从节点。<strong>异步代表主节点的数据和从节点不是强一致的</strong></p>
<h2 id="运维问题"><a href="#运维问题" class="headerlink" title="运维问题"></a>运维问题</h2><h3 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h3><p>当我们将读请求分摊到从节点，只对主节点执行写操作，业务上无法避免下列问题</p>
<h4 id="数据延迟"><a href="#数据延迟" class="headerlink" title="数据延迟"></a>数据延迟</h4><p>前面提到主从的数据复制是异步的。所以受限于网络带宽和命令的处理速度，主从之间的数据不可能强一致。对于存在的延迟，可以考虑添加监控，根据具体的延迟情况，来做出优化调整。</p>
<p>首先这个外部监控程序监控的数据是<strong>主从节点的复制偏移量之差</strong>。如果超过设置的阈值，那么就触发报警，客户端这时候收到通知可以考虑调整从节点。</p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822165615.png" alt="image.png"></p>
<h4 id="过期数据"><a href="#过期数据" class="headerlink" title="过期数据"></a>过期数据</h4><p>版本原因。Redis处理过期数据有一种策略是定期删除。也就是通过定时任务，在一段时间内进行采样，对采样到的数据中的过期键执行del命令，再将del命令同步给从节点。</p>
<p>在老版本中，如果遇到大量数据过期，主节点可能对这批数据还没有采样到，那么从节点收到读命令，就会返回过期数据。<strong>但是在3.2之后，从节点会执行惰性删除，也就是读取数据之前会检查过期时间</strong></p>
<h3 id="从节点故障"><a href="#从节点故障" class="headerlink" title="从节点故障"></a>从节点故障</h3><p>具体分析在哨兵一章</p>
<h3 id="规避全量复制"><a href="#规避全量复制" class="headerlink" title="规避全量复制"></a>规避全量复制</h3><p>前面提到了，全量复制非常耗费资源，且不稳定。所以在实际运维中，我们需要尽量规避全量复制。</p>
<ul>
<li>在主节点数据量大，流量也大的情况下，添加从节点时考虑在<strong>低峰时进行</strong></li>
<li><strong>主节点故障重启之后</strong>，运行ID发生变化，从节点发现运行Id不匹配后，会重新发起全量复制。考虑使用哨兵进行自动的故障转移。</li>
<li><strong>复制积压缓冲区过小，</strong>正常执行部分复制，发现缓冲区已经没有对应的数据了，不得不进行全量复制。所以需要我们通过监控，日志，结合这些数据，分析出<strong>网络中断的时长，写命令数据量的平均值</strong>，调整得出一个合理的缓冲区大小。<h4 id="规避复制风暴"><a href="#规避复制风暴" class="headerlink" title="规避复制风暴"></a>规避复制风暴</h4></li>
</ul>
<p>回到之前的拓扑图上。如果按照普通的一主多从，那么当多个从节点要对同一个主节点，或者同一个机器上的多个主节点发起全量复制，那么主节点所在的机器需要面临巨大的开销，CPU，内存，网络带宽都有消耗。</p>
<p>首先Redis对于大量从节点挂载复制数据的情况是有一定的优化的。比如公用一份RDB，避免重复创建。但是无法避免向多个从节点进行网络传输。这种情况下，只有考虑使用树状拓扑，将压力分给二级主节点，<strong>并且这些主节点不能够在同一个机器上，否则资源还是不够</strong> 。 但不可忽略的是，这种拓扑提供了运维的复杂度</p>
<h1 id="阻塞问题大分析"><a href="#阻塞问题大分析" class="headerlink" title="阻塞问题大分析"></a>阻塞问题大分析</h1><p>Redis是单线程架构，所有的读写操作都在一条线程上，在高并发下，一旦出现阻塞，哪怕是很短时间，都会影响到全局。（Redis作为很多服务的中间件存在）</p>
<h2 id="发现阻塞"><a href="#发现阻塞" class="headerlink" title="发现阻塞"></a>发现阻塞</h2><p>借助日志系统，当异常发生时，通过自定义的Appender实现触发告警的逻辑。如果使用的是Redis集群，那么在异常打印时，还需要加上节点的ip和port。</p>
<h2 id="内因分析"><a href="#内因分析" class="headerlink" title="内因分析"></a>内因分析</h2><h3 id="使用API和数据结构不合理"><a href="#使用API和数据结构不合理" class="headerlink" title="使用API和数据结构不合理"></a>使用API和数据结构不合理</h3><p>Redis执行命令速度非常快，但是如果命令使用不合理，或者处理的对象数据结构使用不合理，都会导致慢查询。</p>
<p>Redis原生支持慢查询统计，通过slowlog get{n} 获取最近的n条慢查询命令。<strong>慢查询只记录命令执行的耗时，也就是说如果某条命令的执行缓慢被记录，有可能是因为要等待其他命令的执行</strong><br>当发现慢查询后，有两个方向去做出调整。</p>
<ul>
<li>替换成低时间复杂度的命令，比如hgetall改成hmget，禁用一些全库遍历的命令</li>
<li>调整大对象（大key）： 缩减大对象的数据量，或者将其拆分成多个小对象，防止一次命令操作过多的数据。具体拆分需要结合业务</li>
</ul>
<blockquote>
<p>Redis 提供 redis-cli-h{ip}-p{port}-bigkeys 命令，可以扫描出大对象</p>
</blockquote>
<h3 id="内部CPU饱和"><a href="#内部CPU饱和" class="headerlink" title="内部CPU饱和"></a>内部CPU饱和</h3><p>Redis是单线程架构，执行命令只使用一个CPU。我们需要关注CPU的使用情况，当CPU出于高使用率，不论是Redis自身使用还是其他进程占用，都会导致Redis无法处理更多的命令，面对大流量会阻塞。</p>
<p>通过redis-cli -stat查看redis使用情况，在这里<strong>每秒的请求高达6w+</strong>。意味着是大流量导致CPU占用率高。<br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822165725.png" alt="image.png"></p>
<p>我们还可以用 info commandstats，根据统计信息，分析一下某些命令的开销时间是否正常。</p>
<p>hset命令算法复杂度只有O（1）但平均耗时却达到135微秒，显然不合理，正常情况耗时应该在10微秒以下。这是因为上面的Redis实例为了追求低内存使用量，过度放宽ziplist使用条件。虽然采用ziplist编码后hash结构内存占用会变小，但是<strong>操作变得更慢且更消耗CPU</strong></p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822165734.png" alt="image.png"></p>
<h3 id="持久化阻塞"><a href="#持久化阻塞" class="headerlink" title="持久化阻塞"></a>持久化阻塞</h3><p>持久化引起主线程的阻塞主要有：fork阻塞，AOF刷盘阻塞， HugePage写操作阻塞。</p>
<h4 id="fork阻塞"><a href="#fork阻塞" class="headerlink" title="fork阻塞"></a>fork阻塞</h4><p>fork阻塞发生在子进程复制主进程的页表，以及COW发生时。atest_fork_usec指标，表示Redis最近一次fork操作耗时。如果较大需要做出调整，比如调整实例的内存，检查当前使用的操作系统。</p>
<h4 id="AOF刷盘阻塞"><a href="#AOF刷盘阻塞" class="headerlink" title="AOF刷盘阻塞"></a>AOF刷盘阻塞</h4><p>刷盘策略一般采用everySec，但是这不意味着主线程就彻底异步了。当异步线程执行fsync，因为磁盘压力过大时发生阻塞时，下一次fsync开始执行，会</p>
<h4 id="HugePage写操作阻塞"><a href="#HugePage写操作阻塞" class="headerlink" title="HugePage写操作阻塞"></a>HugePage写操作阻塞</h4><p>如果操作系统开启了Transparent HugePages，那么每次cow复制的内存页单位就从4K变成了2MB，拖慢了复制的时间。</p>
<h2 id="外因分析"><a href="#外因分析" class="headerlink" title="外因分析"></a>外因分析</h2><h3 id="CPU竞争"><a href="#CPU竞争" class="headerlink" title="CPU竞争"></a>CPU竞争</h3><p>前面提到Redis是CPU密集型应用，当和其他CPU密集型服务部署在一起，会影响Redis的吞吐量。即便这个CPU是多核的，但也会存在CPU的调度和上下文切换</p>
<p>如果一台机子的CPU是多核的，那么可以考虑将Redis进程绑定到其中一个核心。<strong>但是在进行持久化过程，fork出的子进程会大量占用CPU，两个进程竞争一个核心，主进程吞吐量下降</strong></p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822165756.png" alt="image.png"></p>
<h3 id="内存交换"><a href="#内存交换" class="headerlink" title="内存交换"></a>内存交换</h3><p>Redis的高性能的一个重要前提是数据都在内存中。如果机器的内存不足，那么系统会执行swap，将内存的数据转移到磁盘，需要的时候再加载回来，又回到了传统数据库的低性能了。<br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822165809.png" alt="image.png"></p>
<h3 id="网络问题"><a href="#网络问题" class="headerlink" title="网络问题"></a>网络问题</h3><h4 id="连接拒绝"><a href="#连接拒绝" class="headerlink" title="连接拒绝"></a>连接拒绝</h4><p>有时候网络可能存在波动，最好的方式就是避免客户端与Redis进行异地机房调用<br>其次我们需要考虑到高并发情况，高并发意味着同时需要建立多个连接。<br>由于Redis有参数<strong>maxclients控制客户端的最大连接数，</strong>超过这个阈值就会拒绝新的连接。在Map/Reduce场景下，很容易出现连接数过多。因为Map/Reduce的执行逻辑就是：</p>
<ul>
<li>map阶段：将输入数据集分割成多个chunk，交给多个节点并行处理，这些处理的数据会存在Redis。</li>
<li>Reduce阶段：从数据库拉取Map阶段的中间结果，再次处理。</li>
</ul>
<p>客户端会频繁的创建和销毁连接，但是Redis不会主动关闭和检查闲置的TCP连接，也就是连接数快速消耗但无法释放。设置tcp-keepalive和timeout参数让Redis主动检查和关闭无效连接。</p>
<p>客户端和Redis的连接是建立在TCP连接上。这也会受限。首先一个连接对应一个文件句柄，操作系统会对一个进程能够建立的文件句柄做出限制。<br>其次TCP连接过程，是有一个backlog缓冲区，是为了提高连接建立的吞吐量，这一块也需要调整。</p>
<h1 id="理解内存"><a href="#理解内存" class="headerlink" title="理解内存"></a>理解内存</h1><h2 id="内存消耗"><a href="#内存消耗" class="headerlink" title="内存消耗"></a>内存消耗</h2><p>Redis进程内的消耗主要包括：自身内存+对象内存+缓冲内存+碎片内存。自身内存也就是Redis进程本身，消耗微乎其微，可以不用考虑。</p>
<h3 id="对象内存"><a href="#对象内存" class="headerlink" title="对象内存"></a>对象内存</h3><p>对象内存占用空间最大。Redis每次创建一个键值对，就要创建一个Key对象和一个Value对象。所以对象内存的计算就是sizeof(keys) + sizeof(values). keys都是字符串，而Value包含之前提到的物种基本类型。</p>
<h3 id="缓冲内存"><a href="#缓冲内存" class="headerlink" title="缓冲内存"></a>缓冲内存</h3><p>Redis与客户端连接时，会分配一块缓冲区，用来缓冲客户端的输入和自己的输出。客户端也有分类。其中从节点视角的客户端，主节点会为其单独建立一条连接用于命令复制。使用发布订阅功能，订阅的客户端也会单独分到一块缓冲区，如果消费消息的速度跟不上生产消息的速度，会出现一出</p>
<p>在复制的一章有提到，为了实现部分复制，Redis还划分了一块复制积压缓冲区，用来临时保存最近的写命令。</p>
<p>在持久化一节，提到AOF重写期间的增量数据会保存到一块AOF重写缓存区中</p>
<h3 id="碎片内存"><a href="#碎片内存" class="headerlink" title="碎片内存"></a>碎片内存</h3><p>Redis采用的内存分配器时jemalloc，它是以内存块单位分配空间的。比如保存一个5Kb的对象，Jemalloc可能分配一个8Kb内存块，剩下的3Kb就变成了随便，不能够分配了。</p>
<p>如果经常对数据进行更新或者过期删除，那么空间得不到释放，就会导致碎片率上升</p>
<blockquote>
<p>当对一个键进行更新操作(如append、setrange)时,新的值可能会超出原来分配的内存块大小。这时jemalloc会重新分配一个更大的内存块来存储新的值,而原来的内存块就会被释放。</p>
<p>但是,这个被释放的内存块可能无法立即被其他数据所利用。比如,原来的值是3KB,jemalloc分配了4KB的内存块。现在新的值变成了5KB,jemalloc会分配8KB的内存块,而原来的4KB内存块就被释放了。但是,由于jemalloc的内存分配策略,这个4KB的内存块可能无法满足其他数据的需求,从而变成了内存碎片。</p>
</blockquote>
<h2 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h2><p>Redis可以通过config set maxmemeory来设置最大可用内存。在内存使用超过这个阈值后，会触发内存溢出控制。同时Redis也会依靠过期策略来控制内存使用。</p>
<h3 id="删除过期对象"><a href="#删除过期对象" class="headerlink" title="删除过期对象"></a>删除过期对象</h3><p>Redis可以为每个键值对设置过期时间，但是实际过期删除并不是精准地到点删除。因为这样会消耗大量的CPU。实际情况是采用惰性删除和定时策略。</p>
<h4 id="惰性删除"><a href="#惰性删除" class="headerlink" title="惰性删除"></a>惰性删除</h4><p>当客户端读取到超时的键时，再删除这个键，并且返回空。问题是如果过期间一直没有被访问，那么就永远不会被删除，对应的内存不能够得到释放。</p>
<h4 id="定时任务删除"><a href="#定时任务删除" class="headerlink" title="定时任务删除"></a>定时任务删除</h4><p>内部维护一个定时任务，每10秒执行一次。会随机抽取20个键，对其中的过期键进行删除。如果发现过期键占比产过25%，就会重复这个任务逻辑，直到占比不超过25%。如果这个循环的时间超过了设定的25毫秒，那么就直接结束。</p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822165913.png" alt="image.png"></p>
<h3 id="内存溢出控制"><a href="#内存溢出控制" class="headerlink" title="内存溢出控制"></a>内存溢出控制</h3><p>Redis提供六种策略，来决策，当内存超过阈值，如何清理数据或者摆烂。</p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250822165921.png" alt="image.png"></p>
<p>如果选择非noeviction的策略，那么内存控制被触发时，实际上是三步走。循环查找需要删除的键，删除并回收内存，最后再执行命令。</p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250825112302.png" alt="image.png"></p>
<h2 id="内存优化"><a href="#内存优化" class="headerlink" title="内存优化"></a>内存优化</h2><h3 id="缩减键值对象"><a href="#缩减键值对象" class="headerlink" title="缩减键值对象"></a>缩减键值对象</h3><p>key：在能够完整描述业务情况下，尽量缩短键的长度</p>
<p>value：Value存储的都是业务对象。我们首先要考虑当前的业务对象是否有不必要的属性。其次业务对象可以序列化成二进制数组，配合高效的序列化工具，可以更大程度地存储数据。如果采用Json，那么可以考虑使用压缩算法，压缩后再存入。</p>
<h3 id="共享对象池"><a href="#共享对象池" class="headerlink" title="共享对象池"></a>共享对象池</h3><p>Redis内部会维护一个[0-9999]的整数对象池，如果我们在满足需求情况下，都尽量使用整数对象，那么就能够实现复用节约空间。</p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250825112314.png" alt="image.png"></p>
<h1 id="哨兵机制"><a href="#哨兵机制" class="headerlink" title="哨兵机制"></a>哨兵机制</h1><h2 id="解决的问题"><a href="#解决的问题" class="headerlink" title="解决的问题"></a>解决的问题</h2><p>在复制一章中，探讨了主从架构的实现和好处。但是在实际生产环境中，需要考虑风险。所以如果主节点出现故障，那么主从架构该如何继续运转下去。在引入哨兵之前，解决方案是靠人工去执行下面操作：</p>
<ul>
<li>手动修改一个从节点，将其晋升为主节点。</li>
<li>修改应用方使用的主节点地址</li>
<li>发送命令，让其他从节点去主动复制新的主节点</li>
</ul>
<p>这个解决思路没有问题，最大的麻烦时需要人工接入。通过引入哨兵，可以实现自动故障转移。</p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250825112332.png" alt="image.png"></p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250825112338.png" alt="image.png"></p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250825112345.png" alt="image.png"></p>
<h2 id="安装和部署"><a href="#安装和部署" class="headerlink" title="安装和部署"></a>安装和部署</h2><p>使用redis-sentinel命令来启动Redis，具体的启动参数写在一个conf文件下。<br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250825112355.png" alt="image.png"></p>
<p>哨兵只要和主节点建立连接之后，就可以获得主节点下的从节点和其他哨兵的信息。</p>
<p>部署尽量选择奇数个哨兵，这样在能够满足选举条件的同时，可以节省一个节点</p>
<h3 id="拓展功能"><a href="#拓展功能" class="headerlink" title="拓展功能"></a>拓展功能</h3><p>哨兵在完成故障转移操作后，可以执行脚本，只需要在配置输入脚本的路径即可。</p>
<p>哨兵可以同时监控多个主节点，只需要指定不同的主节点名字。</p>
<h2 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h2><p>客户端也就是应用方，如何在哨兵完成故障转移后，能够收到通知，切换主节点。</p>
<p>以 jedis 为例，我们只需要传给 jedis 一个哨兵集合，主节点的名字，jedis 就会执行下列的步骤</p>
<ul>
<li>遍历哨兵集合，去和配置的主节点做比对，判断是否一致。一致则代表找到了一个可用的哨兵。找不到则抛出异常。</li>
<li>找到哨兵，也就找到了主节点，也就是找到了其他的哨兵。</li>
<li>客户端给每一个哨兵节点创建一个线程，订阅哨兵的 switch-master 频道。哨兵会在故障转移后在这个频道上发布消息。</li>
</ul>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><h3 id="三个监控"><a href="#三个监控" class="headerlink" title="三个监控"></a>三个监控</h3><p>一个哨兵节点通过三个定时监控任务实现节点发现和监控</p>
<h4 id="发现节点"><a href="#发现节点" class="headerlink" title="发现节点"></a>发现节点</h4><p>每隔十秒，向主节点和从节点发送 info 命令，获取拓扑结构。当有新的从节点加入可以感知到。</p>
<h4 id="哨兵之间同步"><a href="#哨兵之间同步" class="headerlink" title="哨兵之间同步"></a>哨兵之间同步</h4><p>每隔两秒，在自己监控下的节点的 Sentinel-hello频道发布自己对主节点状态的判断，以及自己的节点信息。</p>
<h4 id="对其他节点监控"><a href="#对其他节点监控" class="headerlink" title="对其他节点监控"></a>对其他节点监控</h4><p>每个一秒，哨兵节点会向其他节点发送ping命令，做心跳检测，确认这些节点是否可达。这个任务是判断节点异常的重要依据</p>
<h3 id="主观下线"><a href="#主观下线" class="headerlink" title="主观下线"></a>主观下线</h3><p>哨兵节点每秒的心跳检测，如果对应的节点在规定时间内没有有效回复，那么当前哨兵节点就会主观认为这个节点已经挂掉了。</p>
<p><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250825112440.png" alt="image.png"></p>
<h3 id="客观下线"><a href="#客观下线" class="headerlink" title="客观下线"></a>客观下线</h3><p>当哨兵节点认为的主观下线节点是主节点时，就会询问其他的哨兵节点，他们对主节点状态的判断。只要这个值超过设置的“quorum”， 那么这个哨兵节点就可以做出客观下线的决定，也就是开始故障转移。<br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250825112504.png" alt="image.png"></p>
<blockquote>
<p>这里和其他哨兵节点沟通是通过sentinel is-master-down-by-addr命令。这里会传一个*，代表响应方的返回结果代表他们对当前主节点的是否可达。如果是一个具体的运行ID，也就是自己的，响应方的返回结果代表是否同意自己当领导者</p>
</blockquote>
<h3 id="节点选举"><a href="#节点选举" class="headerlink" title="节点选举"></a>节点选举</h3><p>在确定要对主节点进行故障转移后，首先要选一个哨兵节点来执行具体的流程。这里的选举思路如下：<br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250825112543.png" alt="image.png"><br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250825112555.png" alt="image.png"><br><img src="https://obsidian-1317277327.cos.ap-chengdu.myqcloud.com/attachment/20250825112614.png" alt="image.png"></p>
<p><strong>基本上谁先完成客观下线，谁就是领导者。</strong></p>
<h3 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h3><ul>
<li>在从节点列表中选择一个节点作为新的节点，选择标准是：<ul>
<li>过滤掉主观下线的，与主节点失联过且较长时间，5秒内没有回复过哨兵节点的ping。</li>
<li>选择slave-priority参数的值最大的</li>
<li>选择复制偏移量最大的。</li>
<li>选择runid最小的。</li>
</ul>
</li>
<li>哨兵对选出的从节点执行slave no one命令，晋升为主节点</li>
<li>哨兵发送命令，让其他的从节点切换主节点。</li>
<li>将原先的主节点更新完从节点，并且监控，当他恢复后去复制新的主节点。<h2 id="运维问题-1"><a href="#运维问题-1" class="headerlink" title="运维问题"></a>运维问题</h2></li>
</ul>
<h3 id="节点下线"><a href="#节点下线" class="headerlink" title="节点下线"></a>节点下线</h3><p>节点下线分为<br><strong>临时下线</strong>：暂时关闭节点，后续会重新启动<br><strong>永久下线：</strong> 将节点关掉后不再使用，需要进行一些清理工作。<br>对主节点下线过程是，选择一个比较优秀的从节点，哨兵直接执行failover，强制开启故障转移。如果一个主节点存在多个从节点，那我们可以把剩余节点的salve priority设置为0；<br>对于从节点，我们需要考虑读写分离情况下，确保应用方知道节点下线的变化，从而将读请求路由到其他的节点。</p>
<h3 id="节点上线"><a href="#节点上线" class="headerlink" title="节点上线"></a>节点上线</h3><p>上线一个新的从节点，无非是为了解决几个问题：</p>
<ul>
<li>现有的从节点已经无法支撑应用方的流量</li>
<li>主节点没有可用的从节点来支持故障转移</li>
<li>需要用一个性能更好的新的从节点来替换原先的主节点</li>
</ul>
<p>只需要配置好从节点的slave信息，然后启动即可。哨兵会感知到从节点的上线。<br>上线一个哨兵节点，情况是：</p>
<ul>
<li>当前的哨兵节点不够，导致系统健壮性不足，或者无法投票选举</li>
<li>去替换原先的哨兵节点。<br>也是只需要添加主节点的配置，然后启动，等待其他哨兵发现。<a href=""></a><br>添加主节点比较简单，因为哨兵只认一个主节点，直接手动执行sentinel failover发起故障转移即可</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>《Redis开发与运维》读书笔记</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://casonhqc.github.io/posts/b92a275f.html">https://casonhqc.github.io/posts/b92a275f.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>Cason</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2024-09-05</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2025-09-26</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>Redis</a><a class="post-meta__tags" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>读书笔记</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">投喂作者</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://tuchuang.voooe.cn/images/2023/01/04/2.webp" target="_blank"><img class="post-qr-code-img" src="https://tuchuang.voooe.cn/images/2023/01/04/2.webp" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://tuchuang.voooe.cn/images/2023/01/04/20f8e49805975b8f8.webp" target="_blank"><img class="post-qr-code-img" src="https://tuchuang.voooe.cn/images/2023/01/04/20f8e49805975b8f8.webp" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/b14427db.html"><img class="prev-cover" src="https://source.fomal.cc/img/default_cover_14.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">AOP原理解析（一）：撕掉神秘面纱，AOP就是这么简单</div></div></a></div><div class="next-post pull-right"><a href="/posts/17f07a5a.html"><img class="next-cover" src="https://source.fomal.cc/img/default_cover_14.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">快速排序算法详解</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E7%89%B9%E6%80%A7"><span class="toc-text">Redis 特性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%80%9F%E5%BA%A6%E5%BF%AB"><span class="toc-text">1.速度快</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%9F%BA%E4%BA%8E%E9%94%AE%E5%80%BC%E5%AF%B9%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">2.基于键值对的数据结构服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%B8%B0%E5%AF%8C%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-text">3.丰富的功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%AE%80%E5%8D%95%E7%A8%B3%E5%AE%9A"><span class="toc-text">4.简单稳定</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#API-%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="toc-text">API 的理解和使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%91%BD%E4%BB%A4"><span class="toc-text">全局命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E5%86%85%E9%83%A8%E7%BC%96%E7%A0%81"><span class="toc-text">数据结构和内部编码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-text">字符串</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E5%91%BD%E4%BB%A4"><span class="toc-text">重要命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E7%BC%96%E7%A0%81"><span class="toc-text">内部编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">使用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-text">缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E6%95%B0"><span class="toc-text">计数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB-Session"><span class="toc-text">共享 Session</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%90%E9%80%9F"><span class="toc-text">限速</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%88%E5%B8%8C"><span class="toc-text">哈希</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E5%91%BD%E4%BB%A4-1"><span class="toc-text">重要命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E7%BC%96%E7%A0%81-1"><span class="toc-text">内部编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="toc-text">使用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98-1"><span class="toc-text">缓存</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%97%E8%A1%A8"><span class="toc-text">列表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8%E5%AE%9E%E7%8E%B0"><span class="toc-text">文章列表实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E5%90%88"><span class="toc-text">集合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E5%91%BD%E4%BB%A4-2"><span class="toc-text">重要命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E7%BC%96%E7%A0%81-2"><span class="toc-text">内部编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE%E5%8A%9F%E8%83%BD"><span class="toc-text">标签功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%EF%BC%88sorted-set%EF%BC%89"><span class="toc-text">有序集合（sorted set）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E5%91%BD%E4%BB%A4-3"><span class="toc-text">重要命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E7%BC%96%E7%A0%81-3"><span class="toc-text">内部编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD"><span class="toc-text">点赞功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E9%94%AE%EF%BC%88Key%EF%BC%89"><span class="toc-text">管理键（Key）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%B8%AA%E9%94%AE%E7%AE%A1%E7%90%86"><span class="toc-text">单个键管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E5%91%BD%E5%90%8DKey"><span class="toc-text">重命名Key</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6Key%E7%9A%84%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="toc-text">控制Key的过期时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%81%E7%A7%BBKey"><span class="toc-text">迁移Key</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%90%E8%BF%9B%E5%BC%8F%E9%81%8D%E5%8E%86Key"><span class="toc-text">渐进式遍历Key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86"><span class="toc-text">数据库管理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E5%B7%A5%E5%85%B7"><span class="toc-text">Redis的一些小工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E5%88%86%E6%9E%90"><span class="toc-text">慢查询分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E4%B8%AA%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="toc-text">两个配置参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-text">最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pipeline"><span class="toc-text">Pipeline</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E9%94%99%E8%AF%AF"><span class="toc-text">命令错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E9%94%99%E8%AF%AF"><span class="toc-text">运行时错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Watch%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-text">Watch乐观锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lua%E8%84%9A%E6%9C%AC"><span class="toc-text">lua脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="toc-text">发布订阅</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JAVA%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A4%A7%E5%AF%B9%E6%AF%94"><span class="toc-text">JAVA客户端大对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4"><span class="toc-text">客户端管理命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A0%87%E8%AF%86"><span class="toc-text">客户端标识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-text">输入缓冲区</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%BC%82%E5%B8%B8"><span class="toc-text">客户端常见异常</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E6%B3%95%E4%BB%8E%E8%BF%9E%E6%8E%A5%E6%B1%A0%E8%8E%B7%E5%8F%96%E5%88%B0%E8%BF%9E%E6%8E%A5"><span class="toc-text">无法从连接池获取到连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%93%E5%86%B2%E5%8C%BA%E5%BC%82%E5%B8%B8"><span class="toc-text">客户端缓冲区异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-text">客户端案例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E5%86%85%E5%AD%98%E9%99%A1%E5%A2%9E"><span class="toc-text">Redis内存陡增</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%A8%E6%9C%9F%E6%80%A7%E8%B6%85%E6%97%B6"><span class="toc-text">客户端周期性超时</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RDB"><span class="toc-text">RDB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%9C%BA%E5%88%B6"><span class="toc-text">触发机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E8%AF%B4%E6%98%8E"><span class="toc-text">流程说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9%E5%88%86%E6%9E%90"><span class="toc-text">优缺点分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E7%82%B9"><span class="toc-text">优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9"><span class="toc-text">缺点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOF"><span class="toc-text">AOF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E8%AF%B4%E6%98%8E-1"><span class="toc-text">流程说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E7%AD%96%E7%95%A5"><span class="toc-text">同步策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E6%9C%BA%E5%88%B6"><span class="toc-text">重写机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text">流程分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D%E5%92%8C%E4%BC%98%E5%8C%96"><span class="toc-text">问题定位和优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fork%E6%93%8D%E4%BD%9C"><span class="toc-text">fork操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fork%E6%93%8D%E4%BD%9C%E6%BD%9C%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">fork操作潜在的问题是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96"><span class="toc-text">如何优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E8%BF%9B%E7%A8%8B%E5%BC%80%E9%94%80%E7%9B%91%E6%8E%A7%E5%92%8C%E4%BC%98%E5%8C%96"><span class="toc-text">子进程开销监控和优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU"><span class="toc-text">CPU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98"><span class="toc-text">内存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AC%E7%9B%98"><span class="toc-text">硬盘</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AOF%E8%BF%BD%E5%8A%A0%E9%98%BB%E5%A1%9E"><span class="toc-text">AOF追加阻塞</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6"><span class="toc-text">复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%93%E6%89%91%E5%9B%BE"><span class="toc-text">拓扑图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E"><span class="toc-text">一主一从</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%BB%E5%A4%9A%E4%BB%8E"><span class="toc-text">一主多从</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%91%E7%8A%B6%E4%B8%BB%E4%BB%8E"><span class="toc-text">树状主从</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-1"><span class="toc-text">流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BF%9D%E5%AD%98%E4%B8%BB%E8%8A%82%E7%82%B9%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-text">1.保存主节点的信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%8E%E4%B8%BB%E8%8A%82%E7%82%B9%E5%BB%BA%E7%AB%8Bsocket%E5%91%BD%E4%BB%A4"><span class="toc-text">2.与主节点建立socket命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8F%91%E9%80%81ping%E5%91%BD%E4%BB%A4"><span class="toc-text">3.发送ping命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81"><span class="toc-text">4.权限验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE"><span class="toc-text">5.同步数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6"><span class="toc-text">全量复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E5%A4%8D%E5%88%B6"><span class="toc-text">部分复制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E4%BF%9D%E6%8C%81%E8%BF%9E%E6%8E%A5%E6%8C%81%E7%BB%AD%E5%A4%8D%E5%88%B6%E6%95%B0%E6%8D%AE"><span class="toc-text">6.保持连接持续复制数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E7%BB%B4%E9%97%AE%E9%A2%98"><span class="toc-text">运维问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-text">读写分离</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BB%B6%E8%BF%9F"><span class="toc-text">数据延迟</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%9C%9F%E6%95%B0%E6%8D%AE"><span class="toc-text">过期数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C"><span class="toc-text">从节点故障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E9%81%BF%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6"><span class="toc-text">规避全量复制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E9%81%BF%E5%A4%8D%E5%88%B6%E9%A3%8E%E6%9A%B4"><span class="toc-text">规避复制风暴</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E9%97%AE%E9%A2%98%E5%A4%A7%E5%88%86%E6%9E%90"><span class="toc-text">阻塞问题大分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E7%8E%B0%E9%98%BB%E5%A1%9E"><span class="toc-text">发现阻塞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%9B%A0%E5%88%86%E6%9E%90"><span class="toc-text">内因分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8API%E5%92%8C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8D%E5%90%88%E7%90%86"><span class="toc-text">使用API和数据结构不合理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E9%83%A8CPU%E9%A5%B1%E5%92%8C"><span class="toc-text">内部CPU饱和</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E9%98%BB%E5%A1%9E"><span class="toc-text">持久化阻塞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fork%E9%98%BB%E5%A1%9E"><span class="toc-text">fork阻塞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF%E5%88%B7%E7%9B%98%E9%98%BB%E5%A1%9E"><span class="toc-text">AOF刷盘阻塞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HugePage%E5%86%99%E6%93%8D%E4%BD%9C%E9%98%BB%E5%A1%9E"><span class="toc-text">HugePage写操作阻塞</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E5%9B%A0%E5%88%86%E6%9E%90"><span class="toc-text">外因分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU%E7%AB%9E%E4%BA%89"><span class="toc-text">CPU竞争</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%BA%A4%E6%8D%A2"><span class="toc-text">内存交换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98"><span class="toc-text">网络问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%8B%92%E7%BB%9D"><span class="toc-text">连接拒绝</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%90%86%E8%A7%A3%E5%86%85%E5%AD%98"><span class="toc-text">理解内存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%B6%88%E8%80%97"><span class="toc-text">内存消耗</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98"><span class="toc-text">对象内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%86%85%E5%AD%98"><span class="toc-text">缓冲内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A2%8E%E7%89%87%E5%86%85%E5%AD%98"><span class="toc-text">碎片内存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-text">内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%BF%87%E6%9C%9F%E5%AF%B9%E8%B1%A1"><span class="toc-text">删除过期对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%83%B0%E6%80%A7%E5%88%A0%E9%99%A4"><span class="toc-text">惰性删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%88%A0%E9%99%A4"><span class="toc-text">定时任务删除</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA%E6%8E%A7%E5%88%B6"><span class="toc-text">内存溢出控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-text">内存优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%A9%E5%87%8F%E9%94%AE%E5%80%BC%E5%AF%B9%E8%B1%A1"><span class="toc-text">缩减键值对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%AF%B9%E8%B1%A1%E6%B1%A0"><span class="toc-text">共享对象池</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6"><span class="toc-text">哨兵机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">解决的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E9%83%A8%E7%BD%B2"><span class="toc-text">安装和部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%93%E5%B1%95%E5%8A%9F%E8%83%BD"><span class="toc-text">拓展功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-1"><span class="toc-text">客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E4%B8%AA%E7%9B%91%E6%8E%A7"><span class="toc-text">三个监控</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E7%8E%B0%E8%8A%82%E7%82%B9"><span class="toc-text">发现节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E4%B9%8B%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="toc-text">哨兵之间同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E7%9B%91%E6%8E%A7"><span class="toc-text">对其他节点监控</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%A7%82%E4%B8%8B%E7%BA%BF"><span class="toc-text">主观下线</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E8%A7%82%E4%B8%8B%E7%BA%BF"><span class="toc-text">客观下线</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E9%80%89%E4%B8%BE"><span class="toc-text">节点选举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-text">故障转移</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E7%BB%B4%E9%97%AE%E9%A2%98-1"><span class="toc-text">运维问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E4%B8%8B%E7%BA%BF"><span class="toc-text">节点下线</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E4%B8%8A%E7%BA%BF"><span class="toc-text">节点上线</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">格言🧬</p><div class="bg-ad"><div>再看看那个光点，它就在这里，这是家园，这是我们 —— 你所爱的每一个人，你认识的一个人，你听说过的每一个人，曾经有过的每一个人，都在它上面度过他们的一生✨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">点击开启星辰之旅</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">猜你想看💡</p><ul class="ft-links"><li><a href="/posts/eec9786.html">魔改指南</a><a href="/box/nav/">网址导航</a></li><li><a href="/social/link/">我的朋友</a><a href="/comments/">留点什么</a></li><li><a href="/personal/about/">关于作者</a><a href="/archives/">文章归档</a></li><li><a href="/categories/">文章分类</a><a href="/tags/">文章标签</a></li><li><a href="/box/Gallery/">我的画廊</a><a href="/personal/bb/">我的唠叨</a></li><li><a href="/site/time/">建设进程</a><a href="/site/census/">网站统计</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">推荐友链⌛</p><div class="ft-img-group"><div class="img-group-item"><a target="_blank" rel="noopener" href="https://www.fomal.cc/" title="Fomalhaut🥝"><img src="https://lskypro.acozycotage.net/LightPicture/2022/12/60e5d4e39da7c077.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div></div></div></div><div class="copyright"><span><b>&copy;2022-2025</b></span><span><b>&nbsp;&nbsp;By Cason</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v6.3.0"><img src="https://sourcebucket.s3.ladydaily.com/badge/Frame-Hexo-blue.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v4.3.1"><img src="https://sourcebucket.s3.ladydaily.com/badge/Theme-Butterfly-6513df.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="本站采用多线部署，主线路托管于Vercel"><img src="https://sourcebucket.s3.ladydaily.com/badge/Hosted-Vercel-brightgreen.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://user.51.la/" style="margin-inline:5px" title="本站数据分析得益于51la技术支持"><img src="https://sourcebucket.s3.ladydaily.com/badge/Analytics-51la-3db1eb.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20226665" style="margin-inline:5px" title="本站已加入萌ICP豪华套餐，萌ICP备20226665号"><img src="https://sourcebucket.s3.ladydaily.com/badge/萌ICP备-20226665-fe1384.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://bitiful.dogecast.com/buckets" style="margin-inline:5px" title="本网站经Service Worker分流至缤纷云对象存储"><img src=" https://sourcebucket.s3.ladydaily.com/badge/Bucket-缤纷云-9c62da.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="本站使用网盾星球提供CDN加速与防护"><img src="https://sourcebucket.s3.ladydaily.com/badge/CDN-网盾星球-fff2cc.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="本网站源码由Github提供存储仓库"><img src=" https://sourcebucket.s3.ladydaily.com/badge/Source-Github-d021d6.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="右键模式" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="分享链接" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>空降评论</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>关于博客</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>美化设置</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>切换全屏</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>打印页面</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: '',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: '',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><a class="magnet_link_more"  href="https://casonhqc.github.io/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://source.fomal.cc/img/default_cover_14.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">Markdown语法与外挂标签写法汇总</a><div class="blog-slider__text">🥧本文汇总Markdown格式以及外挂标签在网页端的渲染效果，可作为文档进行查询</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><!-- hexo injector body_end end --></body></html>